{% extends "base.html" %}
{% block title %}Twisted Brew - Brews{% endblock %}

{% block real_content %}
    <h2>Charts</h2>


<script type="text/javascript">
var setTempchartData = [], probeTempchartData = [], dummyData = [];
var setTemp = 0, probeTemp = 0, timeStamp = 0, noUpdateCount = 1;
var chartData;
var totalPoints = 100; // 720 - one hour mash, five sec update
var updateInterval = 1000; // milliseconds
var initUpdateInterval = updateInterval;
var now = new Date().getTime();

var dataset = [
        { label: "Set Temp:" + setTemp + "°C", data: setTempchartData, lines: {fill: true,  lineWidth: 1.0 }, color: "rgba(0, 255, 0, 0.4)" },
        { label: "Probe Temp:" + probeTemp + "°C", data: probeTempchartData, lines: {lineWidth: 2.0}, color: "rgba(255, 0, 0, 0.8)" },
        { label: "", data: dummyData, lines: {lineWidth: 0.0}, color: "rgba(0, 0, 0, 0.0)" }
    ];

var options = {
    xaxis: {
        mode: "time",
        tickSize: [5, "second"], // controls the space between each tick (vertical grid line) shown on the xaxis,
        tickFormatter: function (v, axis) {
            var date = new Date(v);
            if (date.getSeconds() % 20 == 0) { // controls the space between printed ticks (so they don't overlap)
                var hours = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
                var minutes = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
                var seconds = date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds();

                return hours + ":" + minutes + ":" + seconds;
            } else {
                return "";
            }
        },
        axisLabel: "Time",
        axisLabelUseCanvas: true,
        axisLabelFontSizePixels: 12,
        axisLabelFontFamily: 'Verdana, Arial',
        axisLabelPadding: 10
    },
    yaxes: [
        {
            min: 0,
            max: 110,
            tickSize: 5,
            tickFormatter: function (v, axis) {
                if (v % 5 == 0) {
                    return v ;
                } else {
                    return "";
                }
            },
            axisLabel: "Temp °C",
            axisLabelUseCanvas: true,
            axisLabelFontSizePixels: 12,
            axisLabelFontFamily: 'Verdana, Arial',
            axisLabelPadding: 6
        }
    ],
    legend: {
        noColumns: 0,
        position:"nw"
    },
    grid: {
        backgroundColor: { colors: ["#ffffff", "#EDF5FF"] }
    }
};

function initData() {
    for (var i = 0; i < totalPoints; i++) {
        var chartData = [now += updateInterval, 0];

        dummyData.push(chartData);
    }
}

function backOff(){
    updateInterval =+ initUpdateInterval*noUpdateCount;
    if(noUpdateCount < 5){
        noUpdateCount++;
    }else{
        noUpdateCount = 1;
    }
}

function update(_data) {
    var l = _data.latest_timestamp.length;
    if (l == 0){
        backOff();
    }else{
        updateInterval = initUpdateInterval;
        noUpdateCount = 1;
    }
    for (i = 0; i < l; i++) {
        timeStamp = _data.latest_timestamp[i];
        setTemp = _data.latest_set_point[i];
        probeTemp = _data.latest_probe_temp[i];
        if (setTempchartData.length >= totalPoints) {
            setTempchartData.shift();
            probeTempchartData.shift();
        }
        chartData = [timeStamp, setTemp];
        setTempchartData.push(chartData);
        chartData = [timeStamp, probeTemp];
        probeTempchartData.push(chartData);
        dummyData.shift();
    }

    dataset[0].label = "Set Temp:" + setTemp + "°C";
    dataset[1].label = "Probe Temp:" + probeTemp + "°C";

    $.plot($("#flot-placeholder1"), dataset, options);
    setTimeout(getData, updateInterval);
}


function getData() {
    $.ajaxSetup({ cache: false });
    $.ajax({
        url: "http://127.0.0.1:8000/charts_update/",
        dataType: 'json',
        type: 'POST',
        data: {timestamp: timeStamp+1000, csrfmiddlewaretoken: '{{ csrf_token }}'},
        success: update,
        error: function () {
            backOff;
            setTimeout(getData, updateInterval);
        }
    });
}

$(document).ready(function () {
    initData();

    $.plot($("#flot-placeholder1"), dataset, options);
    setTimeout(getData, updateInterval);
});


</script>
<!-- HTML -->
<div>Mash Temp Graph</div>
<div id="flot-placeholder1" style="width:1000px;height:500px;margin:0"></div>
<div>Fermentation Temp Graph</div>
<div id="flot-placeholder2" style="width:1000px;height:500px;margin:0"></div>

{% endblock %}